<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tiankong.mapper.DirectoryMapper">
    <!-- 添加知识点 -->
    <insert id="addDirectory" parameterType="com.tiankong.pojo.Directory" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO directory
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <!-- 如果传入了 id，则显式插入 id 字段 -->
            <if test="id != null">id,</if>
            name,
            clevel,
            content,
            parent_id
        </trim>
        VALUES
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <!-- 如果传入了 id，则显式插入 id 值 -->
            <if test="id != null">#{id},</if>
            #{name},
            #{clevel},
            #{content},
            #{parentId}
        </trim>
    </insert>

    <!-- 更新知识点 -->
    <update id="updateChildIds">
        UPDATE directory
        <set>
        <!-- 动态更新字段 -->
        <if test="name != null and name != ''">name = #{name},</if>
        <if test="childId != null">child_id = #{childId},</if>
        <if test="clevel != null">clevel = #{clevel},</if>
        <if test="content != null">content = #{content},</if>
        <if test="parentId != null">parent_id = #{parentId},</if>
        </set>
        WHERE id = #{id}

    </update>

    <!-- 按id查询 -->
    <select id="getById" resultType="com.tiankong.pojo.Directory">
        SELECT
            id,
            name,
            clevel,
            content,
            parent_id AS parentId,
            child_id AS childId
        FROM directory
        WHERE id = #{id}
    </select>

    <!-- list查询 -->
    <select id="findSubTree" resultType="com.tiankong.pojo.Directory">
        WITH RECURSIVE cte AS (
            SELECT
                id,
                name,
                clevel,
                content,
                parent_id AS parentId,
                child_id AS childId
            FROM directory
            WHERE id = #{id}
            UNION ALL
            SELECT
                d.id,
                d.name,
                d.clevel,
                d.content,
                d.parent_id AS parentId,
                d.child_id AS childId
            FROM directory d
                     INNER JOIN cte ON d.parent_id = cte.id
        )
        SELECT * FROM cte
    </select>

    <!-- 循环查询统计 -->
    <select id="countSubtreeNodes" resultType="int">
        WITH RECURSIVE subtree AS (
            SELECT id FROM directory WHERE id = #{id}
            UNION ALL
            SELECT d.id FROM directory d
                                 INNER JOIN subtree s ON d.parent_id = s.id
        )
        SELECT COUNT(*) FROM subtree
    </select>

    <!-- 执行删除（触发级联删除） -->
    <delete id="deleteById">
        DELETE FROM directory WHERE id = #{id}
    </delete>

</mapper>